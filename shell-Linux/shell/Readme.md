# Shell

## 内部元素

### 变量

1. 声明 `my_var="I'm a variable"` 定义变量时无需加美元符号`$`，在变量名和等号之间不能有空格
2. 调用时 `${my_var}` 其中大括号可以省略，但是最好保留习惯
3. `set` 列出所有变量； `unset VAR` 撤销变量
4. 只读 `readonly my_var` 将使变量不能被修改和删除
5. 删除 `unset my_var`

变量类型：

1. 局部变量：在脚本或命令中定义，仅在当前 shell 实例中有效
2. 环境变量：系统环境，可以自定义新的
   1. 在配置文件中要 `export VAR=VALUE` 来声明
3. shell 变量：由 shell 程序设置的特殊变量

### 字符串

字符串`string="my string"`是shell编程中最常用最有用的数据类型（除了数字和字符串，也没啥其它类型好用了），字符串可以用单引号，也可以用双引号，<u>也可以不用引号</u>。

- 单引号：内部调用变量无效；不能使转义生效
- 双引号：可以有变量；可以生效转义字符

拼接字符串：`'hello, '${string}' !'  ` 实现拼接，即不需要“+”

获取字符串长度： `echo ${#string}`

提取子串： `echo ${string:n:m}` 索引从 0 开始

查找子字符串： 

```shell
echo `expr index "$string" io` # 查找字符 i 或 o 的位置，哪个先出现就返回哪个索引
```

### 数组

只支持一维数组

```shell
arr_name=(val0 val1 val2 val3)
```

数组元素用**空格**来分隔，也可直接给下标赋值来创建，下标范围没有限制

- 读取数组： `${arr[i]}` 读取单个； `${arr[@]}` 用 @ 或 * 符号获取全部元素
- 获取长度： ${#arr[@]}

### 函数

```shell
[ function ] funcname [()]
{
	action;
	[return int;]
}
function start() {
	echo "starting"
}
```

1. 可以带 function fun() 定义，也可以直接 fun() 定义，不带任何参数
2. 参数返回，可以显式加：return 返回，如果不加，将以最后一条命令运行结果作为返回值
3. 函数返回值在调用该函数后通过 `$?` 来获得
4. 向函数传递参数与向脚本传递参数调用方法一致

### 运算符



算数运算符（以下 a = 10, b = 20）表达式和运算符之间要有空格

原生 bash 不支持数学运算，需要 awk 、 expr 等命令来实现

| 运算符 | 说明                                          | 举例                            |
| :----- | :-------------------------------------------- | :------------------------------ |
| +      | 加法                                          | \`expr $a + $b\` 结果为 30。    |
| -      | 减法                                          | \`expr $a - $b\` 结果为 -10。   |
| *      | 乘法                                          | \`expr $a \* $b\` 结果为  200。 |
| /      | 除法                                          | \`expr $b / $a\` 结果为 2。     |
| %      | 取余                                          | \`expr $b % $a\` 结果为 0。     |
| =      | 赋值                                          | a=$b 将把变量 b 的值赋给 a。    |
| ==     | 相等。用于比较两个数字，相同则返回 true。     | [ $a == $b ] 返回 false。       |
| !=     | 不相等。用于比较两个数字，不相同则返回 true。 | [ $a != $b ] 返回 true。        |

- 条件表达式要放在括号内，并且要有空格；

关系运算符

只支持数字，除非字符串的值是数字

| 运算符 | 说明                                                  | 举例                       |
| :----- | :---------------------------------------------------- | :------------------------- |
| -eq    | 检测两个数是否相等，相等返回 true。                   | [ $a -eq $b ] 返回 false。 |
| -ne    | 检测两个数是否不相等，不相等返回 true。               | [ $a -ne $b ] 返回 true。  |
| -gt    | 检测左边的数是否大于右边的，如果是，则返回 true。     | [ $a -gt $b ] 返回 false。 |
| -lt    | 检测左边的数是否小于右边的，如果是，则返回 true。     | [ $a -lt $b ] 返回 true。  |
| -ge    | 检测左边的数是否大于等于右边的，如果是，则返回 true。 | [ $a -ge $b ] 返回 false。 |
| -le    | 检测左边的数是否小于等于右边的，如果是，则返回 true。 | [ $a -le $b ] 返回 true。  |

布尔运算符

| 运算符 | 说明                                                | 举例                                     |
| :----- | :-------------------------------------------------- | :--------------------------------------- |
| !      | 非运算，表达式为 true 则返回 false，否则返回 true。 | [ ! false ] 返回 true。                  |
| -o     | 或运算，有一个表达式为 true 则返回 true。           | [ $a -lt 20 -o $b -gt 100 ] 返回 true。  |
| -a     | 与运算，两个表达式都为 true 才返回 true。           | [ $a -lt 20 -a $b -gt 100 ] 返回 false。 |

字符串运算符（下面 a="abc" ， b="efg"）

| 运算符 | 说明                                         | 举例                     |
| :----- | :------------------------------------------- | :----------------------- |
| =      | 检测两个字符串是否相等，相等返回 true。      | [ $a = $b ] 返回 false。 |
| !=     | 检测两个字符串是否不相等，不相等返回 true。  | [ $a != $b ] 返回 true。 |
| -z     | 检测字符串长度是否为0，为0返回 true。        | [ -z $a ] 返回 false。   |
| -n     | 检测字符串长度是否不为 0，不为 0 返回 true。 | [ -n "$a" ] 返回 true。  |
| $      | 检测字符串是否为空，不为空返回 true。        | [ $a ] 返回 true。       |

文件测试运算符

| 操作符  | 说明                                                         | 举例                      |
| :------ | :----------------------------------------------------------- | :------------------------ |
| -b file | 检测文件是否是块设备文件，如果是，则返回 true。              | [ -b $file ] 返回 false。 |
| -c file | 检测文件是否是字符设备文件，如果是，则返回 true。            | [ -c $file ] 返回 false。 |
| -d file | 检测文件是否是目录，如果是，则返回 true。                    | [ -d $file ] 返回 false。 |
| -f file | 检测文件是否是普通文件（既不是目录，也不是设备文件），如果是，则返回 true。 | [ -f $file ] 返回 true。  |
| -g file | 检测文件是否设置了 SGID 位，如果是，则返回 true。            | [ -g $file ] 返回 false。 |
| -k file | 检测文件是否设置了粘着位(Sticky Bit)，如果是，则返回 true。  | [ -k $file ] 返回 false。 |
| -p file | 检测文件是否是有名管道，如果是，则返回 true。                | [ -p $file ] 返回 false。 |
| -u file | 检测文件是否设置了 SUID 位，如果是，则返回 true。            | [ -u $file ] 返回 false。 |
| -r file | 检测文件是否可读，如果是，则返回 true。                      | [ -r $file ] 返回 true。  |
| -w file | 检测文件是否可写，如果是，则返回 true。                      | [ -w $file ] 返回 true。  |
| -x file | 检测文件是否可执行，如果是，则返回 true。                    | [ -x $file ] 返回 true。  |
| -s file | 检测文件是否为空（文件大小是否大于0），不为空返回 true。     | [ -s $file ] 返回 true。  |
| -e file | 检测文件（包括目录）是否存在，如果是，则返回 true。          | [ -e $file ] 返回 true。  |
| -S file | 判断文件是否 socket                                          |                           |
| -L file | 检测文件是否存在并且是一个符号链接（软链接）                 |                           |

### 注释

```shell
# 单行注释
:<<'
注释内容...
'
```

## 命令

### echo

用于字符串的输出

### printf

`printf format-string [arguments...]`

- format-string：为格式控制字符串
- arguments：为参数列表

### test

用于检查某个条件是否成立，可以进行数值、字符和文件三个方面的测试

#### 数值测试

| 参数 | 说明           |
| :--- | :------------- |
| -eq  | 等于则为真     |
| -ne  | 不等于则为真   |
| -gt  | 大于则为真     |
| -ge  | 大于等于则为真 |
| -lt  | 小于则为真     |
| -le  | 小于等于则为真 |

#### 字符串测试

| 参数      | 说明                     |
| :-------- | :----------------------- |
| =         | 等于则为真               |
| !=        | 不相等则为真             |
| -z 字符串 | 字符串的长度为零则为真   |
| -n 字符串 | 字符串的长度不为零则为真 |

#### 文件测试

| 参数      | 说明                                 |
| :-------- | :----------------------------------- |
| -e 文件名 | 如果文件存在则为真                   |
| -r 文件名 | 如果文件存在且可读则为真             |
| -w 文件名 | 如果文件存在且可写则为真             |
| -x 文件名 | 如果文件存在且可执行则为真           |
| -s 文件名 | 如果文件存在且至少有一个字符则为真   |
| -d 文件名 | 如果文件存在且为目录则为真           |
| -f 文件名 | 如果文件存在且为普通文件则为真       |
| -c 文件名 | 如果文件存在且为字符型特殊文件则为真 |
| -b 文件名 | 如果文件存在且为块特殊文件则为真     |

此外用 与(-a)、或(-o)、非(!)三个逻辑操作符来将测试条件连起来，优先级 `!`>`-a`>`-o`

```shell
cd /bin
if test -e ./notFile -o -e ./bash
then
    echo '至少有一个文件存在!'
else
    echo '两个文件都不存在'
fi
# 至少有一个文件存在!
```

## 流程控制

shell 的流程控制不允许为空，不操作就不要加

### if else

```shell
if [ $(ps -ef | grep -c "ssh") -gt 1]; then echo "true"; fi # 带管道
```

```shell
if condition1
then
	command1
elif condition2
then
	command2
else
	commandN
fi
```

### for 循环

```shell
for var in item1 item2 ... itemN; do command1; command2… done;
```

```shell
for var in item1 item2 ... itemN
do
	command1
	command2
	...
	commandN
done
```

### while 语句

```shell
while condition
do
	command
done
```

可用于读取键盘信息

```shell
echo '按下 <CTRL-D> 退出'
echo -n '输入你最喜欢的网站名: '
while read FILM
do
    echo "是的！$FILM 是一个好网站"
done
```

### until 循环

执行一系列命令直到条件为 true 时停止

```shell
until condition
do
	command
done
```

### case ... esac

多选择语句，如 switch ... case；每个 case 分支用右圆括号开始，用两个分号`;;` 表示 break ， esac 作为结束标记

```shell
case 值 in
模式1)
    command1
    command2
    ...
    commandN
    ;;
模式2）
    command1
    command2
    ...
    commandN
    ;;
esac
```

## 传递参数

在执行 Shell 脚本时可以传递参数，脚本内获取参数格式为：

$n 代表获取到的第 n 个参数（从 1 开始），十以上的参数要用大括号包含，如 ${10}

而 $0 表示执行的文件名（包含文件路径）

几个处理参数的特殊字符

| 参数处理 | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| $#       | 传递到脚本的参数个数                                         |
| $*       | 以一个**单字符串**显示所有向脚本传递的参数                   |
| $$       | 脚本运行的当前进程 PID 号                                    |
| $!       | 后台运行的最后一个进程 & 的 PID 号                           |
| $@       | 与 $* 相同，单时使用时加引号，并在引号中返回每个参数         |
| $-       | 显示 Shell 使用的当前选项，与 set 命令功能相同               |
| $?       | 显示最后命令的推出状态。0 表示没有错误，其他任何值表明有错误 |

## 输入/输出重定向

大多数 UNIX 系统命令从你的终端接受输入并将所产生的输出发送回到您的终端。一个命令通常从一个叫标准输入的地方读取输入，默认情况下，这恰好是你的终端。同样，一个命令通常将其输出写入到标准输出，默认情况下，这也是你的终端。

| 命令            | 说明                                               |
| :-------------- | :------------------------------------------------- |
| command > file  | 将输出重定向到 file。会覆盖文件内容                |
| command < file  | 将输入重定向到 file。可同时替换输入和输出          |
| command >> file | 将输出以追加的方式重定向到 file。                  |
| n > file        | 将文件描述符为 n 的文件重定向到 file。             |
| n >> file       | 将文件描述符为 n 的文件以追加的方式重定向到 file。 |
| n >& m          | 将输出文件 m 和 n 合并。                           |
| n <& m          | 将输入文件 m 和 n 合并。                           |
| << tag          | 将开始标记 tag 和结束标记 tag 之间的内容作为输入。 |

一般情况下，每个 Unix/Linux 命令运行时都会打开三个文件：

- 标准输入文件(stdin)：stdin的文件描述符为0，Unix程序默认从stdin读取数据。
- 标准输出文件(stdout)：stdout 的文件描述符为1，Unix程序默认向stdout输出数据。
- 标准错误文件(stderr)：stderr的文件描述符为2，Unix程序会向stderr流中写入错误信息。

```shell
$ command 2>file  # 将 stderr 重定向
$ command > file 2>&1 # 将 stdout 和 stderr 合并后重定向
$ command < infile > outfile # 同时重定向
```

### Here Document

```shell
command << delimiter
	document
delimiter
```

将两个 delimiter 之间的内容(document) 作为输入传递给 command

结尾的 delimiter 一定要顶格写

### /dev/null 文件

是一个特殊的文件，写入它的内容都会被丢弃；读取也没用。

```shell
$ command > /dev/null # 禁止输出
```

## 文件包含

```shell
. filename  # 注意点 (.) 和文件名之间的空格，两种方法效果一样
source filename  # 被包含的文件不需要可执行权限
```

